name: Release

concurrency:
  group: ci-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - "*"

jobs:
  wait:
    runs-on: ubuntu-slim
    steps:
      - name: init wait
        run: |
          echo "Waiting for the dependencies build workflow to complete..."
          sleep 180  # Wait for 3 minutes
      - name: Wait for the build ecp-ai workflow to complete
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-name: 'build ecp-ai'
          wait-interval: 10
          allowed-conclusions: success,skipped,cancelled

      - name: Wait for the build trace-exchanger workflow to complete
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-name: 'push multi-arch manifest for trace-exchanger'
          wait-interval: 10
          allowed-conclusions: success,skipped,cancelled

      - name: Wait for the build emqxee-agent workflow to complete
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-name: 'push multi-arch manifests for emqxee-agent images'
          wait-interval: 10
          allowed-conclusions: success,skipped,cancelled

      - name: Wait for the build emqx-bc-web workflow to complete
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-name: 'push multi-arch manifest for ecp-ui'
          wait-interval: 10
          allowed-conclusions: success,skipped,cancelled
  
  docker:
    strategy:
      matrix:
        arch:
          - ubuntu-22.04
          - ubuntu-22.04-arm
        # Add platform information
        include:
          - arch: ubuntu-22.04
            platform: linux/amd64
            suffix_platform: amd64
          - arch: ubuntu-22.04-arm
            platform: linux/arm64
            suffix_platform: arm64
    runs-on: ${{ matrix.arch }}
    needs: wait
    steps:          
      # GitHub App token 有效期固定为1小时，无法修改
      # 如果工作流运行时间超过1小时，需要在使用时重新生成token
      - uses: actions/create-github-app-token@v1
        id: generate-token
        with:
          app-id: ${{ vars.AUTH_APP_ID }}
          private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          # skip-token-revoke: true  # 可选：阻止在job完成时自动撤销token
          repositories: |
            gotools
            emqx-bc-iaas-hand
            neuronex-operator
            EMQX-Business-Critical
            emqx-bc-web
            gorm
            ecp-ai
            emqx-bc-emqxee-agent

      - name: Private repo access
        run: |
          git config --global url."https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com/".insteadOf "https://github.com/"
          echo "GOPRIVATE=github.com/emqx/*" >> $GITHUB_ENV
          echo "GONOPROXY=github.com/emqx/*" >> $GITHUB_ENV
          echo "GONOSUMDB=github.com/emqx/*" >> $GITHUB_ENV
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: emqx/EMQX-Business-Critical
          ref: ${{ github.ref }}
          path: ecp-main
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
      - name: Docker image tag
        id: image
        working-directory: ecp-main
        run: |
          tag="${GITHUB_REF##*/}"
          if [[ ${{ github.event_name }} == "pull_request" ]]; then
            fromBranch="${{ github.head_ref }}"
            if [[ "${fromBranch}" == "build/"* ]]; then
              tag="${fromBranch#build/}"
            else
              tag="${{ github.actor }}"
            fi
          fi
          if [[ "${{github.event_name}}" == "push" ]] && [[ ${{ github.ref_name }} == "develop" ]]; then
              tag="dev-latest"
          fi
          echo "tag=${tag}" >> $GITHUB_OUTPUT
          echo 'registry="ghcr.io/emqxecp/ecp-main"' >> $GITHUB_OUTPUT

      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: |
            ${{ steps.image.outputs.registry }}
          tags: |
            type=raw,value=${{ steps.image.outputs.tag }},enabled=${{ github.ref_type != 'tag' }}
            type=semver,pattern={{version}},enabled=${{ github.ref_type == 'tag' }}
            type=semver,pattern={{major}}.{{minor}},enabled=${{ github.ref_type == 'tag' }}
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.EMQXECP_GIT_TOKEN }}
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v3
        with:
          context: ./ecp-main
          push: true
          # tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            GIT_TOKEN=${{ steps.generate-token.outputs.token }}
          labels: ${{ steps.meta.outputs.labels }}
          file: ecp-main/build/docker_build/Dockerfile
          outputs: type=image,name=ghcr.io/emqxecp/ecp-main,push-by-digest=true,name-canonical=true
          # Disable attestation to avoid conflicts with digest-based pushing
          provenance: false

      - name: Export ecp-main digest
        run: |
          echo "${{ steps.build.outputs.digest }}" > ecp-main-digest.txt
      - uses: actions/upload-artifact@v4
        with:
          name: ecp-main-digest-${{ matrix.suffix_platform }}
          path: ecp-main-digest.txt

      - name: Check Docker Compose command version
        working-directory: ./ecp-main/deployments/docker-compose
        run: |
          echo "$GITHUB_REF"
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            CURRENT_TAG="${GITHUB_REF##*/}"
            # 新增正则校验
            if ! echo "$CURRENT_TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+)?(-(alpha|beta|rc)\.[0-9]+)?$'; then
              echo "Invalid tag format: $CURRENT_TAG"
              echo "Tag must match pattern: [major].[minor].[patch](-customer)(-[prerelease].[number])"
              exit 1
            fi

            # 自动更新版本
            sed -i "s#ci-auto-use-tag-instead#${CURRENT_TAG}#g" emqx_ecp_ctl
          else
            echo "Not triggered by tag, skipping"
          fi
      - name: Get dependency images
        id: get-dependency-images
        working-directory: ./ecp-main
        run: |
          cd deployments/docker-compose
          echo 'images<<EOF' >> $GITHUB_OUTPUT
          while read -r image; do
            # 排除指定镜像
            if [[ "$image" =~ (trace-exchanger|ecp-emqx-agent-downloader|ecp-emqx-agent|ecp-ai|ecp-main|ecp-ui) ]]; then
              continue
            fi
            echo "$image"
            echo "$image" >> $GITHUB_OUTPUT
          done <<< "$(echo -e '\n\n' | ./emqx_ecp_ctl configure --show-images | tail -n +3)"
          echo 'EOF' >> $GITHUB_OUTPUT
      - name: Download dependency images
        run: |
          while read -r image; do
            docker pull $image
          done <<< "${{ steps.get-dependency-images.outputs.images }}"
      - name: Push dependency images to ghcr.io
        run: |
          while read -r image; do
            name="${image##*/}"
            target="ghcr.io/emqxecp/${name}-${{ matrix.suffix_platform }}"
            docker tag "$image" "$target"
            docker push "$target"
          done <<< "${{ steps.get-dependency-images.outputs.images }}"
      - name: Collect dependency image digests
        run: |
          > dependency-digests.txt
          while read -r image; do
            name="${image##*/}"
            rd=$(docker buildx imagetools inspect "ghcr.io/emqxecp/${name}-${{ matrix.suffix_platform }}" --format "{{.Manifest.Digest}}")
            echo "$image ghcr.io/emqxecp/${name}-${{ matrix.suffix_platform }}@${rd}" >> dependency-digests.txt
          done <<< "${{ steps.get-dependency-images.outputs.images }}"
      - uses: actions/upload-artifact@v4
        with:
          name: dependency-digests-${{ matrix.suffix_platform }}
          path: dependency-digests.txt

  build-ubuntu:
    strategy:
      matrix:
        arch:
          - ubuntu-22.04
          - ubuntu-22.04-arm
        # Add platform information
        include:
          - arch: ubuntu-22.04
            platform: linux/amd64
            suffix_platform: amd64
          - arch: ubuntu-22.04-arm
            platform: linux/arm64
            suffix_platform: arm64
    runs-on: ${{ matrix.arch }}
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate-token
        with:
          app-id: ${{ vars.AUTH_APP_ID }}
          private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            gotools
            emqx-bc-iaas-hand
            neuronex-operator
            EMQX-Business-Critical
            emqx-bc-web
            gorm
            ecp-ai

      - name: Private repo access
        run: |
          git config --global url."https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com/".insteadOf "https://github.com/"
          echo "GOPRIVATE=github.com/emqx/*" >> $GITHUB_ENV
          echo "GONOPROXY=github.com/emqx/*" >> $GITHUB_ENV
          echo "GONOSUMDB=github.com/emqx/*" >> $GITHUB_ENV

      - name: Checkout
        uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: emqx/EMQX-Business-Critical
          ref: ${{ github.ref }}
          path: ecp-main
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: Set up Go
        id: go
        uses: actions/setup-go@v3
        with:
          go-version: '1.22.0'

      # package
      - name: Package
        env:
          GIT_TOKEN: ${{ steps.generate-token.outputs.token }}
          DASHBOARD_VERSION: ${{ github.ref_name }}
          ALL_IN_ONE: true
        working-directory: ecp-main
        run: make pkg_all_in_one
      
      - name: Check Docker Compose command version
        working-directory: ./ecp-main/deployments/docker-compose
        run: |
          CURRENT_TAG="${GITHUB_REF##*/}"
          
          # 新增正则校验
          if ! echo "$CURRENT_TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+)?(-(alpha|beta|rc)\.[0-9]+)?$'; then
            echo "Invalid tag format: $CURRENT_TAG"
            echo "Tag must match pattern: [major].[minor].[patch](-customer)(-[prerelease].[number])"
            exit 1
          fi

          # 自动更新版本
          # 判断 sed 版本，根据不同版本执行不同命令
          if sed --version 2>/dev/null | grep -q GNU; then
              # GNU 版本的 sed
              sed -i "s#ci-auto-use-tag-instead#${CURRENT_TAG}#g" emqx_ecp_ctl
          else
              # BSD 版本的 sed
              sed -i '' "s#ci-auto-use-tag-instead#${CURRENT_TAG}#g" emqx_ecp_ctl
          fi

      - name: Package of docker compose
        working-directory: ./ecp-main/deployments
        run: |
          cp -f ./scripts/emqx_ecp.conf.arm64 ./docker-compose/emqx_ecp.conf
          version=$(echo ${{ github.ref_name }} | sed 's|[/:_]|-|g')
          tar \
            --exclude="docker-compose/.gitingore" \
            --exclude="docker-compose/configs" \
            --exclude="docker-compose/datavolumes" \
            -zcvf emqx-ecp-${{ matrix.suffix_platform }}-docker-compose-installer-${version}.tar.gz \
            docker-compose

      - uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.suffix_platform }}
          path: |
            ./ecp-main/deployments/emqx-ecp-${{ matrix.suffix_platform }}-docker-compose-installer*
            ./ecp-main/emqx-bc-service-in-one-${{ github.ref_name }}*
          if-no-files-found: error 

  manifest:
    runs-on: ubuntu-22.04
    needs:
      - docker
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.EMQXECP_GIT_TOKEN }}
      - name: Docker image tag
        id: image
        run: |
          tag="${GITHUB_REF##*/}"
          if [[ "${{github.event_name}}" == "push" ]] && [[ ${{ github.ref_name }} == "develop" ]]; then
              tag="dev-latest"
          fi
          echo "tag=${tag}" >> $GITHUB_OUTPUT
          echo 'registry="ghcr.io/emqxecp/ecp-main"' >> $GITHUB_OUTPUT
      - uses: docker/metadata-action@v5
        id: meta
        with:
          images: |
            ${{ steps.image.outputs.registry }}
          tags: |
            type=raw,value=${{ steps.image.outputs.tag }},enabled=${{ github.ref_type != 'tag' }}
            type=semver,pattern={{version}},enabled=${{ github.ref_type == 'tag' }}
            type=semver,pattern={{major}}.{{minor}},enabled=${{ github.ref_type == 'tag' }}
      - uses: actions/download-artifact@v4
        with:
          name: ecp-main-digest-amd64
          path: ecp-main-digest-amd64
      - uses: actions/download-artifact@v4
        with:
          name: ecp-main-digest-arm64
          path: ecp-main-digest-arm64
      - name: Create and push multi-arch manifest for ecp-main
        run: |
          amd64=$(cat ecp-main-digest-amd64/ecp-main-digest.txt)
          arm64=$(cat ecp-main-digest-arm64/ecp-main-digest.txt)
          for tag in ${{ steps.meta.outputs.tags }}; do
            docker buildx imagetools create -t "$tag" \
              ghcr.io/emqxecp/ecp-main@${amd64} \
              ghcr.io/emqxecp/ecp-main@${arm64}
          done
      - uses: actions/download-artifact@v4
        with:
          name: dependency-digests-amd64
          path: dep-amd64
      - uses: actions/download-artifact@v4
        with:
          name: dependency-digests-arm64
          path: dep-arm64
      - uses: docker/setup-buildx-action@v3
      - name: Create and push multi-arch manifests for dependencies
        continue-on-error: false
        timeout-minutes: 20
        run: |
          declare -A MAP
          while read -r image digest; do
              MAP["$image"]+=" ${digest}"
          done < dep-amd64/dependency-digests.txt
          while read -r image digest; do
              MAP["$image"]+=" ${digest}"
          done < dep-arm64/dependency-digests.txt

          for image in "${!MAP[@]}"; do
              target=ghcr.io/emqxecp/${image##*/}
              set -- ${MAP["$image"]}
              
              echo "=== 开始推送多架构镜像: $target ==="
              
              max_retries=3
              retry_count=0
              
              while [ $retry_count -le $max_retries ]; do
                  echo "尝试 $((retry_count + 1))/$((max_retries + 1))"
                  
              if docker buildx imagetools create -t "$target" "$@" 2>&1; then
                  echo "✓ 成功推送: $target"
                  break
                  else
                      retry_count=$((retry_count + 1))
                      if [ $retry_count -gt $max_retries ]; then
                          echo "✗ 错误: 推送 $target 失败，已达最大重试次数"
                          exit 1
                      fi
                      wait_time=$((retry_count * 15))
                      echo "推送失败，${wait_time}秒后重试..."
                      sleep $wait_time
                  fi
              done
          done

          echo "所有镜像推送完成！"

  release:
    runs-on: ubuntu-22.04-arm
    needs:
      - build-ubuntu
      - docker
      - manifest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          merge-multiple: true
          path: packages
      - uses: actions/create-github-app-token@v1
        id: generate-token
        with:
          app-id: ${{ vars.AUTH_APP_ID }}
          private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: EMQX-Business-Critical
      - uses: actions/checkout@v4
        with:
          repository: emqx/EMQX-Business-Critical
          ref: ${{ github.ref }}
          path: ecp-main
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
      - name: Check Docker Compose command version
        working-directory: ecp-main/deployments/docker-compose
        run: |
          CURRENT_TAG="${GITHUB_REF##*/}"
          
          # 新增正则校验
          if ! echo "$CURRENT_TAG" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+)?(-(alpha|beta|rc)\.[0-9]+)?$'; then
            echo "Invalid tag format: $CURRENT_TAG"
            echo "Tag must match pattern: [major].[minor].[patch](-customer)(-[prerelease].[number])"
            exit 1
          fi

          # 自动更新版本
          sed -i "s#ci-auto-use-tag-instead#${CURRENT_TAG}#g" emqx_ecp_ctl
      - name: Check pre release
        id: prerelease
        run: |
          echo "prerelease=true" >> $GITHUB_OUTPUT
      - uses: softprops/action-gh-release@v1
        with:
          ## When you use the repository's GITHUB_TOKEN to perform tasks,
          ## events triggered by the GITHUB_TOKEN, with the exception of workflow_dispatch and repository_dispatch,
          ## will not create a new workflow run.
          ## This prevents you from accidentally creating recursive workflow runs.
          ## More info: https://docs.github.com/en/actions/using-workflows/triggering-a-workflow#triggering-a-workflow-from-a-workflow
          token: ${{ github.token }}
          name: ECP application new version ${{ github.ref_name }} Released
          body: ECP application new version ${{ github.ref_name }} has been released
          prerelease: ${{ steps.prerelease.outputs.prerelease }}
          generate_release_notes: true
          files: |
            packages/**
