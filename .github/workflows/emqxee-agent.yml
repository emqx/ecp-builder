name: build emqxee-agent

concurrency:
  group: docker-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - "*"

jobs:
  new-tag:
    name: new-tag
    runs-on: ubuntu-22.04-arm
    outputs:
      skip_build: ${{ steps.check_tag.outputs.skip_build }}
      previous_tag: ${{ steps.check_tag.outputs.previous_tag }}
      current_tag: ${{ steps.check_tag.outputs.current_tag }}

    steps:
      - uses: actions/create-github-app-token@v1
        id: generate-token
        with:
          app-id: ${{ vars.AUTH_APP_ID }}
          private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            emqx-bc-emqxee-agent
            EMQX-Business-Critical
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
      # 拉取 https://github.com/emqx/emqx-bc-emqxee-agent 仓库
      - uses: actions/checkout@v4
        with:
          repository: emqx/emqx-bc-emqxee-agent
          ref: develop
          path: emqx-bc-emqxee-agent
          token: ${{ steps.generate-token.outputs.token }}
          fetch-depth: 0  # 获取完整的 Git 历史记录
          fetch-tags: true  # 确保获取所有 tags
      - name: Add new tag to emqxee-agent
        working-directory: emqx-bc-emqxee-agent
        id: check_tag
        run: |
          set -euo pipefail
          # 获取之前最新的 tag
          previous_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "latest tag: $previous_tag"
          echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT 
          
          # 如果存在 tag，获取该 tag 的 commit ID
          if [ -n "$previous_tag" ]; then
            previous_tag_commit=$(git rev-parse $previous_tag)
            echo "latest tag commit: $previous_tag_commit"
          else
            echo "No tags found in repository"
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

          git config user.name ${{ github.actor }}
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          current_tag=${GITHUB_REF#refs/tags/}
          echo "current tag: $current_tag"
          git tag -d $current_tag || true
          git push --delete origin $current_tag || true
          git tag $current_tag
          git push origin $current_tag

          echo "current_tag=$current_tag" >> $GITHUB_OUTPUT 
          # 获取当前 tag 的 commit ID
          current_tag_commit=$(git rev-parse $current_tag)

          if [ -n "$previous_tag" ]; then         
            if [ "$current_tag_commit" = "$previous_tag_commit" ]; then
              echo "skip_build=true" >> $GITHUB_OUTPUT
              echo "Current tag commit matches previous tag commit, will reuse existing image"
            else
              echo "skip_build=false" >> $GITHUB_OUTPUT
              echo "Current tag commit differs from previous tag commit, will build new image"
            fi
          fi

  build-image:
    name: build emqxee-agent
    runs-on: ${{ matrix.arch }}
    needs: [new-tag]
    strategy:
      fail-fast: false
      matrix:
        arch:
          - ubuntu-22.04
          - ubuntu-22.04-arm
        include:
          - arch: ubuntu-22.04
            platform: linux/amd64
            suffix_platform: amd64
          - arch: ubuntu-22.04-arm
            platform: linux/arm64
            suffix_platform: arm64
        target:
          - image_of_docker: ghcr.io/emqxecp/ecp-emqx-agent-downloader
            file: emqx-bc-emqxee-agent/build/download-proxy/Dockerfile
          - image_of_docker: ghcr.io/emqxecp/ecp-emqx-agent
            file: emqx-bc-emqxee-agent/build/agent/Dockerfile
    steps:
      - uses: actions/create-github-app-token@v1
        id: generate-token
        with:
          app-id: ${{ vars.AUTH_APP_ID }}
          private-key: ${{ secrets.AUTH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            emqx-bc-emqxee-agent
            EMQX-Business-Critical
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}
      # 拉取 https://github.com/emqx/emqx-bc-emqxee-agent 仓库
      - uses: actions/checkout@v4
        with:
          repository: emqx/emqx-bc-emqxee-agent
          ref: develop
          path: emqx-bc-emqxee-agent
          token: ${{ steps.generate-token.outputs.token }}
          fetch-depth: 0  # 获取完整的 Git 历史记录
          fetch-tags: true  # 确保获取所有 tags
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.EMQXECP_GIT_TOKEN }}
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./emqx-bc-emqxee-agent
          file: ${{ matrix.target.file }}
          push: true
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ matrix.target.image_of_docker }},push-by-digest=true,name-canonical=true
          provenance: false
      - name: Set image base
        id: base
        run: |
          name="${{ matrix.target.image_of_docker }}"
          echo "base=${name##*/}" >> $GITHUB_OUTPUT
      - name: Export digest artifact
        run: |
          echo "${{ steps.build.outputs.digest }}" > digest.txt
      - uses: actions/upload-artifact@v4
        with:
          name: digest-${{ steps.base.outputs.base }}-${{ matrix.suffix_platform }}
          path: digest.txt

  manifest-agent:
    name: push multi-arch manifests for emqxee-agent images
    runs-on: ubuntu-22.04
    needs: [build-image]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.EMQXECP_GIT_TOKEN }}
      - name: Check latest image
        id: latest
        run: |
          echo "latest=false" >> $GITHUB_OUTPUT
          if echo "${{ github.ref_name }}" |egrep -q "^[0-9].[0-9].[0-9]$"; then
          echo "latest=true" >> $GITHUB_OUTPUT
          fi
      - name: Metadata for downloader image
        id: meta_downloader
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/emqxecp/ecp-emqx-agent-downloader
          flavor: |
            latest=${{ steps.latest.outputs.latest }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=raw,value=${{ steps.image.outputs.version }},enable=${{ steps.image.outputs.version != '' }}
            type=sha,enable=true,priority=100,prefix=,suffix=,format=short,enable=${{ github.ref_type != 'tag' }}
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=raw,value=dev-latest,enable=${{ github.ref == format('refs/heads/{0}', 'develop') }}
            type=semver,pattern={{version}}
            type=ref,event=branch
            type=raw,value=build,enable=${{ startsWith(github.ref, 'refs/heads/build/') }}
      - uses: actions/download-artifact@v4
        with:
          name: digest-ecp-emqx-agent-downloader-amd64
          path: digests/downloader-amd64
      - uses: actions/download-artifact@v4
        with:
          name: digest-ecp-emqx-agent-downloader-arm64
          path: digests/downloader-arm64
      - name: Create multi-arch manifest for downloader
        run: |
          amd64=$(cat digests/downloader-amd64/digest.txt)
          arm64=$(cat digests/downloader-arm64/digest.txt)
          for tag in ${{ steps.meta_downloader.outputs.tags }}; do
            docker buildx imagetools create -t "$tag" \
              ghcr.io/emqxecp/ecp-emqx-agent-downloader@${amd64} \
              ghcr.io/emqxecp/ecp-emqx-agent-downloader@${arm64}
          done
      - name: Metadata for agent image
        id: meta_agent
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/emqxecp/ecp-emqx-agent
          flavor: |
            latest=${{ steps.latest.outputs.latest }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=raw,value=${{ steps.image.outputs.version }},enable=${{ steps.image.outputs.version != '' }}
            type=sha,enable=true,priority=100,prefix=,suffix=,format=short,enable=${{ github.ref_type != 'tag' }}
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=raw,value=dev-latest,enable=${{ github.ref == format('refs/heads/{0}', 'develop') }}
            type=semver,pattern={{version}}
            type=ref,event=branch
            type=raw,value=build,enable=${{ startsWith(github.ref, 'refs/heads/build/') }}
      - uses: actions/download-artifact@v4
        with:
          name: digest-ecp-emqx-agent-amd64
          path: digests/agent-amd64
      - uses: actions/download-artifact@v4
        with:
          name: digest-ecp-emqx-agent-arm64
          path: digests/agent-arm64
      - name: Create multi-arch manifest for agent
        run: |
          amd64=$(cat digests/agent-amd64/digest.txt)
          arm64=$(cat digests/agent-arm64/digest.txt)
          for tag in ${{ steps.meta_agent.outputs.tags }}; do
            docker buildx imagetools create -t "$tag" \
              ghcr.io/emqxecp/ecp-emqx-agent@${amd64} \
              ghcr.io/emqxecp/ecp-emqx-agent@${arm64}
          done
